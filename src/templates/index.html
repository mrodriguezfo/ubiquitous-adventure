<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>Retornos - Panel FLAR</title>
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <link rel="stylesheet" href="/static/style.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
    /* Small additions for the single-screen responsive layout */
    .top-controls{display:flex;gap:12px;align-items:center;flex-wrap:wrap;margin-bottom:12px}
    .date-select{display:flex;gap:8px;align-items:center}
    .table-card{margin-top:16px}
    @media(max-width:700px){
        .kpi{min-width:100px}
        .uploader .actions{flex-direction:column;align-items:stretch}
    }
    </style>
</head>
<body>
    <header class="header">
        <div class="brand">
            <div class="logo">FL</div>
            <div>
                <h1>FLAR - Retornos</h1>
                <div class="meta">Reporte diario de retornos y valor de mercado</div>
            </div>
        </div>
        <div class="meta">Usuario: Demo &nbsp; | &nbsp; Fecha: <span id="now">--</span></div>
    </header>

    <main class="container">
        <div class="card" style="max-width:900px;margin:20px auto;padding:24px;text-align:left">
            <div style="display:flex;align-items:center;gap:12px">
                <div class="logo" style="width:56px;height:56px;font-size:18px">FL</div>
                <div>
                    <div class="meta" style="font-size:16px;font-weight:600">Moodboard - Visual snapshots</div>
                </div>
            </div>

            <p class="hint" style="margin-top:12px">Sube el archivo RetornosV21.csv y selecciona la fecha que deseas comparar con el último cierre de mes.</p>

            <form id="uploadForm" class="uploader" enctype="multipart/form-data" style="margin-top:12px">
                <div class="top-controls">
                    <input type="file" name="file" id="fileInput" accept=".csv,.txt" />
                    <div class="date-select">
                        <label for="dateSelect">Seleccionar fecha:</label>
                        <select id="dateSelect"></select>
                    </div>
                    <div style="margin-left:auto;display:flex;gap:8px">
                        <button class="btn" type="submit">Procesar</button>
                        <button class="btn" id="pdfBtn" type="button" style="display:none">Descargar PDF</button>
                        <button class="btn" id="previewPdfBtn" type="button" style="display:none">Vista previa PDF</button>
                        <button class="btn" id="previewHtmlBtn" type="button" style="display:none">Vista previa (HTML)</button>
                        <button class="btn" id="emailBtn" type="button" style="display:none">Enviar por correo</button>
                        <button type="button" class="btn secondary" id="clearBtn">Limpiar</button>
                    </div>
                </div>
            </form>

            <div id="summary" style="margin-top:8px;font-size:14px;color:#556"></div>
        </div>

        <div id="snapshots-card" class="card table-card" style="max-width:1100px;margin:18px auto;display:none">
            <h3 style="margin-top:0">Valor de Mercado - Mes anterior vs Fecha seleccionada</h3>
            <div id="snapshots-wrap" class="results-table-wrapper"></div>
        </div>

        
    </main>

    <footer class="footer">FLAR - Aplicación interna de reportes. Diseñado para uso corporativo.</footer>

    <script>
    document.getElementById('now').innerText = new Date().toLocaleString();

    function formatNumber(v){
        if (v === null || v === undefined) return '';
        if (typeof v === 'number') return v.toLocaleString(undefined, {maximumFractionDigits:2});
        return v;
    }

    function formatMoney(v){
        if (v === null || v === undefined || v === '') return '';
        if (typeof v === 'number') return v.toLocaleString(undefined, {style: 'currency', currency: 'USD', maximumFractionDigits:2});
        const n = Number(v);
        if (isNaN(n)) return v;
        return n.toLocaleString(undefined, {style: 'currency', currency: 'USD', maximumFractionDigits:2});
    }

    // Helper to populate date selector from rows
    function populateDateSelect(rows){
        const sel = document.getElementById('dateSelect');
        sel.innerHTML = '';
        const dates = Array.from(new Set(rows.map(r => r['End Date'] || r['Date'] || r['LastDate']).filter(Boolean)));
        // sort descending
        dates.sort((a,b)=> new Date(b) - new Date(a));
        for (const d of dates) {
            const opt = document.createElement('option'); opt.value = d; opt.text = d; sel.appendChild(opt);
        }
        return dates;
    }

    async function loadLocal(){
        const resp = await fetch('/retornos/local', { method: 'GET' });
        const text = await resp.text();
        if (!resp.ok) {
            try { const j = JSON.parse(text); alert('Error: ' + (j.detail || JSON.stringify(j))); } catch(e){ alert('Error: ' + text); }
            return null;
        }
        return JSON.parse(text);
    }

    function buildPortfoliosTable(data, selectedDate){
        const rows = data.rows || [];
        const snapshots = data.snapshots || [];
        const benchmarks = data.benchmarks || [];
        // map snapshots by account to get PrevMonthEnd / PrevMarketValue
        const snapMap = {};
        for (const s of snapshots) snapMap[s.Account] = s;

        // map rows by account+date for quick lookup
        const rowMap = {};
        for (const r of rows) {
            const key = (r.Account || '') + '|' + (r['End Date'] || r['Date'] || r['LastDate'] || '');
            rowMap[key] = r;
        }

        // helper to find benchmark for a portfolio
        function findBenchmarkForRow(row){
            if (!row) return null;
            const perf = (row['Perf. Class'] || '').toString().toLowerCase();
            // try to find benchmark that contains perf class
            for (const b of benchmarks){
                if ((b.Account||'').toString().toLowerCase().includes(perf) && b.TWRR != null) return b;
            }
            // try TOTAL BMK
            for (const b of benchmarks){ if ((b.Account||'').toString().toLowerCase().includes('total') && (b.Account||'').toString().toLowerCase().includes('bmk')) return b; }
            // fallback first benchmark with value
            for (const b of benchmarks){ if (b.TWRR != null) return b; }
            return null;
        }

        // determine unique accounts (order by Account)
        const accounts = Array.from(new Set(rows.map(r=>r.Account))).sort();
        // header: include selected date in header label (date removed from row columns)
        let html = '<table class="results"><thead><tr><th>Portafolio</th><th>Valor PrevMonthEnd</th><th>' + selectedDate + ' - Valor</th><th>Diff</th><th>% Dif</th><th>Retorno</th><th>Benchmark</th></tr></thead><tbody>';
        for (const acct of accounts){
            const snap = snapMap[acct] || {};
            const prevVal = snap.PrevMarketValue != null ? snap.PrevMarketValue : '';
            const key = acct + '|' + selectedDate;
            const row = rowMap[key] || {};
            const selVal = row ? row['Total Market Value'] : '';
            const diff = (typeof selVal === 'number' && typeof prevVal === 'number') ? selVal - prevVal : ((Number(selVal)||0) - (Number(prevVal)||0));
            const pct = (prevVal && prevVal !== 0) ? (diff / prevVal * 100) : '';
            const diffClass = (typeof diff === 'number') ? (diff > 0 ? 'positive' : (diff < 0 ? 'negative' : '')) : '';
            const pctClass = (typeof pct === 'number') ? (pct > 0 ? 'positive' : (pct < 0 ? 'negative' : '')) : '';

            // retorno (TWRR) for the selected date
            const retorno = (row && row['TWRR'] != null) ? (Number(row['TWRR']) * 100) : null;
            // benchmark
            const b = findBenchmarkForRow(row);
            const bmk_ret = b && b.TWRR != null ? (Number(b.TWRR) * 100) : null;
            const bmk_name = b ? b.Account : '';

            html += '<tr>' +
                `<td>${acct}</td>` +
                `<td>${formatMoney(prevVal)}</td>` +
                `<td>${formatMoney(selVal)}</td>` +
                `<td class="diff-cell ${diffClass}">${formatMoney(diff)}</td>` +
                `<td class="diff-pct ${pctClass}">${pct !== '' ? pct.toFixed(2) + '%' : ''}</td>` +
                `<td style="text-align:right">${retorno != null ? retorno.toFixed(2) + '%' : ''}</td>` +
                `<td style="text-align:left">${bmk_name} ${bmk_ret != null ? (' - ' + bmk_ret.toFixed(2) + '%') : ''}</td>` +
                '</tr>';
        }
        html += '</tbody></table>';
        // show snapshots card and render into snapshots-wrap
        const wrap = document.getElementById('snapshots-wrap');
        const card = document.getElementById('snapshots-card');
        if (card) card.style.display = 'block';
        if (wrap) wrap.innerHTML = html; else document.getElementById('file-contents').innerHTML = html;
    }

    function processResponseData(data){
        if (!data) return;
        document.getElementById('summary').innerText = `Filas: ${data.count || 0}`;
        const rows = data.rows || [];
        if (rows.length === 0) { document.getElementById('table-wrap').innerHTML = '<p>No hay datos</p>'; return; }
        const dates = populateDateSelect(rows);
        const defaultDate = dates.length > 0 ? dates[0] : '';
        document.getElementById('dateSelect').value = defaultDate;
        buildPortfoliosTable(data, defaultDate);

        // when changing date selection, rebuild table
        document.getElementById('dateSelect').onchange = (e) => buildPortfoliosTable(data, e.target.value);

        // show pdf and email buttons when data is present
        const pdfBtn = document.getElementById('pdfBtn');
        const previewBtn = document.getElementById('previewPdfBtn');
        const emailBtn = document.getElementById('emailBtn');
        if (pdfBtn) { pdfBtn.style.display = 'inline-block'; pdfBtn.onclick = () => generatePDF(data, false); }
        if (previewBtn) { previewBtn.style.display = 'inline-block'; previewBtn.onclick = () => generatePDF(data, true); }
        const previewHtmlBtn = document.getElementById('previewHtmlBtn');
        if (previewHtmlBtn) { previewHtmlBtn.style.display = 'inline-block'; previewHtmlBtn.onclick = () => showHtmlPreview(data); }
        if (emailBtn) { emailBtn.style.display = 'inline-block'; emailBtn.onclick = () => showEmailModal(data); }
    }

    // form submit
    const form = document.getElementById('uploadForm');
    form.addEventListener('submit', async (e) => {
        e.preventDefault();
        const fileEl = document.getElementById('fileInput');
        const file = fileEl && fileEl.files && fileEl.files[0] ? fileEl.files[0] : null;
        if (!file) { alert('Por favor seleccione un archivo CSV antes de procesar.'); return; }
        const fd = new FormData(); fd.append('file', file);
        const resp = await fetch('/retornos', { method: 'POST', body: fd });
        const text = await resp.text();
        if (!resp.ok) {
            try { const j = JSON.parse(text); alert('Error procesando archivo: ' + (j.detail || JSON.stringify(j))); } catch(er){ alert('Error: ' + text); }
            return;
        }
        const data = JSON.parse(text);
        processResponseData(data);
    });

    // function to call server and open HTML report (server-rendered)
    async function generateReportServer(preview=false){
        try{
            const sel = document.getElementById('dateSelect');
            const selected_date = sel ? sel.value : '';
            const fd = new FormData();
            fd.append('selected_date', selected_date);
            // include file if present
            const fileEl = document.getElementById('fileInput');
            const file = fileEl && fileEl.files && fileEl.files[0] ? fileEl.files[0] : null;
            if (file) fd.append('file', file);
            const resp = await fetch('/retornos/pdf?format=html', { method: 'POST', body: fd });
            if (!resp.ok) { const txt = await resp.text(); alert('Error generando reporte: ' + txt); return; }
            const text = await resp.text();
            // open in new tab/window
            const w = window.open('', '_blank');
            w.document.open();
            w.document.write(text);
            w.document.close();
            if (preview){
                // just show
                return;
            }
            // trigger print for download
            setTimeout(()=>{ w.focus(); w.print(); }, 400);
        }catch(e){ alert('Error: ' + e); }
    }

    // show HTML preview of the report
    function showHtmlPreview(data){
        const sel = document.getElementById('dateSelect');
        const selected_date = sel ? sel.value : '';
        // build a styled HTML report modal
        const modal = document.createElement('div');
        modal.style.position = 'fixed'; modal.style.left = 0; modal.style.top = 0; modal.style.right = 0; modal.style.bottom = 0; modal.style.background = 'rgba(0,0,0,0.6)'; modal.style.display = 'flex'; modal.style.alignItems = 'center'; modal.style.justifyContent = 'center';
        const box = document.createElement('div'); box.style.background = '#fff'; box.style.padding = '18px'; box.style.borderRadius = '8px'; box.style.width = '90%'; box.style.maxWidth='1100px'; box.style.maxHeight='90%'; box.style.overflow='auto';
        // build header with logo and title
        const header = document.createElement('div'); header.style.display='flex'; header.style.alignItems='center'; header.style.justifyContent='space-between'; header.style.marginBottom='12px';
        const left = document.createElement('div'); left.style.display='flex'; left.style.alignItems='center';
        const logo = document.createElement('div'); logo.style.width='64px'; logo.style.height='64px'; logo.style.background='#1f3b82'; logo.style.borderRadius='8px'; logo.style.display='flex'; logo.style.alignItems='center'; logo.style.justifyContent='center'; logo.style.color='#fff'; logo.style.fontWeight='700'; logo.style.fontSize='20px'; logo.innerText='FL';
        left.appendChild(logo);
        const titleWrap = document.createElement('div'); titleWrap.style.marginLeft='12px'; const t1 = document.createElement('div'); t1.style.fontSize='18px'; t1.style.fontWeight='700'; t1.innerText='Valor de Mercado'; const t2 = document.createElement('div'); t2.style.color='#666'; t2.innerText=`Fecha: ${selected_date}`; titleWrap.appendChild(t1); titleWrap.appendChild(t2);
        left.appendChild(titleWrap);
        header.appendChild(left);
        const right = document.createElement('div'); right.style.textAlign='right'; right.innerHTML=`<div style="font-weight:700;color:#1f3b82">FLAR</div><div style="color:#666;font-size:12px">Reporte</div>`;
        header.appendChild(right);
        box.appendChild(header);

        // summary KPIs
        const kpiRow = document.createElement('div'); kpiRow.style.display='flex'; kpiRow.style.gap='12px'; kpiRow.style.marginBottom='12px';
        const totalPort = (data.rows||[]).length;
        const totalVal = (data.rows||[]).reduce((s,r)=>s + (Number(r['Total Market Value'])||0),0);
        const k1 = document.createElement('div'); k1.style.padding='10px'; k1.style.flex='1'; k1.style.background='#f7f9fc'; k1.style.borderRadius='6px'; k1.innerHTML=`<div style="font-size:12px;color:#666">Portafolios</div><div style="font-weight:700;font-size:18px">${totalPort}</div>`;
        const k2 = document.createElement('div'); k2.style.padding='10px'; k2.style.flex='2'; k2.style.background='#f7f9fc'; k2.style.borderRadius='6px'; k2.innerHTML=`<div style="font-size:12px;color:#666">Valor Total</div><div style="font-weight:700;font-size:18px">${(totalVal).toLocaleString(undefined,{style:'currency',currency:'USD'})}</div>`;
        kpiRow.appendChild(k1); kpiRow.appendChild(k2); box.appendChild(kpiRow);

        // table
        const tableWrap = document.createElement('div');
        tableWrap.innerHTML = buildReportHtmlTable(data, selected_date);
        box.appendChild(tableWrap);

        // actions
        const actions = document.createElement('div'); actions.style.marginTop='12px'; actions.style.display='flex'; actions.style.justifyContent='flex-end'; actions.style.gap='8px';
        const exportBtn = document.createElement('button'); exportBtn.className='btn'; exportBtn.innerText='Exportar a PDF (imprimir)'; exportBtn.onclick = ()=>{
            // open new window with printable content
            const w = window.open('','_blank');
            const docHtml = `<!doctype html><html><head><meta charset="utf-8"><title>Informe ${selected_date}</title><link rel="stylesheet" href="/static/style.css"></head><body>${box.innerHTML}</body></html>`;
            w.document.open(); w.document.write(docHtml); w.document.close();
            w.focus();
            // trigger print after small delay
            setTimeout(()=>{ w.print(); },400);
        };
        const closeBtn = document.createElement('button'); closeBtn.className='btn secondary'; closeBtn.innerText='Cerrar'; closeBtn.onclick = ()=> modal.remove();
        actions.appendChild(exportBtn); actions.appendChild(closeBtn); box.appendChild(actions);

        modal.appendChild(box); document.body.appendChild(modal);
    }

    function buildReportHtmlTable(data, selectedDate){
        const rows = data.rows || [];
        const snapshots = data.snapshots || [];
        const snapMap = {};
        for (const s of snapshots) snapMap[s.Account]=s;
        const rowMap = {};
        for (const r of rows){ const key = (r.Account||'') + '|' + (r['End Date']||r['Date']||r['LastDate']||''); rowMap[key]=r; }
        const accounts = Array.from(new Set(rows.map(r=>r.Account))).sort();
        let html = '<table class="report-table" style="width:100%;border-collapse:collapse">';
        html += '<thead><tr style="background:#f0f4f8;color:#333"><th style="text-align:left;padding:8px">Portafolio</th><th style="padding:8px;text-align:right">Valor PrevMonthEnd</th><th style="padding:8px;text-align:right">' + selectedDate + ' - Valor</th><th style="padding:8px;text-align:right">Diff</th><th style="padding:8px;text-align:right">% Dif</th><th style="padding:8px;text-align:right">Retorno</th><th style="padding:8px;text-align:left">Benchmark</th></tr></thead><tbody>';
        for (const acct of accounts){ const snap = snapMap[acct]||{}; const prevVal = snap.PrevMarketValue!=null?snap.PrevMarketValue:''; const key = acct+'|'+selectedDate; const row = rowMap[key]; const selVal = row?row['Total Market Value']:''; const diff = (typeof selVal==='number'&&typeof prevVal==='number')?selVal-prevVal: (Number(selVal)||0) - (Number(prevVal)||0); const pct = (prevVal && prevVal!=0)?(diff/prevVal*100):''; const retorno = (row && row['TWRR'] != null) ? (Number(row['TWRR'])*100) : null; // benchmark
            let bmk = '';
            for (const b of (data.benchmarks||[])){ if ((b.Account||'').toString().toLowerCase().includes((row && row['Perf. Class']||'').toString().toLowerCase())){ bmk = b.Account + (b.TWRR!=null ? (' - ' + (Number(b.TWRR)*100).toFixed(2)+'%') : ''); break; } }
            if(!bmk){ for (const b of (data.benchmarks||[])){ if ((b.Account||'').toString().toLowerCase().includes('total') && (b.Account||'').toString().toLowerCase().includes('bmk')){ bmk = b.Account + (b.TWRR!=null?(' - '+(Number(b.TWRR)*100).toFixed(2)+'%'):''); break; } }
            if(!bmk){ for(const b of (data.benchmarks||[])){ if(b.TWRR!=null){ bmk = b.Account + (' - ' + (Number(b.TWRR)*100).toFixed(2)+'%'); break; } } }
            html += `<tr><td style="padding:8px">${acct}</td><td style="padding:8px;text-align:right">${prevVal?prevVal.toLocaleString(undefined,{style:'currency',currency:'USD'}):''}</td><td style="padding:8px;text-align:right">${selVal?selVal.toLocaleString(undefined,{style:'currency',currency:'USD'}):''}</td><td style="padding:8px;text-align:right">${diff?diff.toLocaleString(undefined,{style:'currency',currency:'USD'}):''}</td><td style="padding:8px;text-align:right">${pct?pct.toFixed(2)+'%':''}</td><td style="padding:8px;text-align:right">${retorno!=null?retorno.toFixed(2)+'%':''}</td><td style="padding:8px;text-align:left">${bmk}</td></tr>` }
        html += '</tbody></table>';
        return html;
    }


    // simple modal to collect SMTP creds and send email
    function showEmailModal(data){
        // create modal markup
        const modal = document.createElement('div');
        modal.style.position = 'fixed'; modal.style.left = 0; modal.style.top = 0; modal.style.right = 0; modal.style.bottom = 0; modal.style.background = 'rgba(0,0,0,0.4)'; modal.style.display = 'flex'; modal.style.alignItems = 'center'; modal.style.justifyContent = 'center';
        const box = document.createElement('div'); box.style.background = '#fff'; box.style.padding = '18px'; box.style.borderRadius = '8px'; box.style.width = '520px'; box.style.maxWidth='95%';
        box.innerHTML = `
            <h3>Enviar informe por correo</h3>
            <div style="display:flex;flex-direction:column;gap:8px;margin-top:8px">
                <label>SMTP Server: <input id="smtp_server" value="smtp.office365.com"/></label>
                <label>SMTP Port: <input id="smtp_port" value="587"/></label>
                <label>Usuario (correo): <input id="smtp_user" value=""/></label>
                <label>Contraseña: <input id="smtp_pass" type="password" value=""/></label>
                <label>Para: <input id="to_email" value="arodriguez@flar.net"/></label>
                <label>Asunto: <input id="email_subject" value="Informe de retornos"/></label>
                <label>Mensaje: <textarea id="email_body" rows="4">Adjunto el informe solicitado.</textarea></label>
                <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:6px">
                    <button id="send_mail_btn" class="btn">Enviar</button>
                    <button id="cancel_mail_btn" class="btn secondary">Cancelar</button>
                </div>
            </div>
        `;
        modal.appendChild(box);
        document.body.appendChild(modal);
        document.getElementById('cancel_mail_btn').onclick = () => modal.remove();
        document.getElementById('send_mail_btn').onclick = async () => {
            const selected_date = document.getElementById('dateSelect').value;
            const smtp_server = document.getElementById('smtp_server').value;
            const smtp_port = document.getElementById('smtp_port').value;
            const smtp_user = document.getElementById('smtp_user').value;
            const smtp_pass = document.getElementById('smtp_pass').value;
            const to_email = document.getElementById('to_email').value;
            const subject = document.getElementById('email_subject').value;
            const body = document.getElementById('email_body').value;
            const fd = new FormData();
            fd.append('selected_date', selected_date);
            fd.append('smtp_server', smtp_server);
            fd.append('smtp_port', smtp_port);
            fd.append('smtp_user', smtp_user);
            fd.append('smtp_pass', smtp_pass);
            fd.append('to_email', to_email);
            fd.append('subject', subject);
            fd.append('body', body);
            try{
                const resp = await fetch('/retornos/email', { method: 'POST', body: fd });
                const j = await resp.json();
                if (!resp.ok) { alert('Error: ' + (j.detail || JSON.stringify(j))); } else { alert('Correo enviado'); modal.remove(); }
            }catch(e){ alert('Error: ' + e); }
        }
    }

    // clear
    document.getElementById('clearBtn').addEventListener('click', () => { const fi = document.getElementById('fileInput'); if (fi) fi.value = null; document.getElementById('dateSelect').innerHTML = ''; document.getElementById('table-wrap').innerHTML = ''; document.getElementById('file-contents').innerHTML = ''; document.getElementById('summary').innerText = ''; });

    </script>
</body>
</html>
