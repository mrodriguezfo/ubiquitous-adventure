<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>Retornos - Panel FLAR</title>
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <link rel="stylesheet" href="/static/style.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
    /* Small additions for the single-screen responsive layout */
    .top-controls{display:flex;gap:12px;align-items:center;flex-wrap:wrap;margin-bottom:12px}
    .date-select{display:flex;gap:8px;align-items:center}
    .table-card{margin-top:16px}
    @media(max-width:700px){
        .kpi{min-width:100px}
        .uploader .actions{flex-direction:column;align-items:stretch}
    }
    </style>
</head>
<body>
    <header class="header">
        <div class="brand">
            <div class="logo">FL</div>
            <div>
                <h1>FLAR - Retornos</h1>
                <div class="meta">Reporte diario de retornos y valor de mercado</div>
            </div>
        </div>
        <div class="meta">Usuario: Demo &nbsp; | &nbsp; Fecha: <span id="now">--</span></div>
    </header>

    <main class="container">
        <div class="card" style="max-width:900px;margin:20px auto;padding:24px;text-align:left">
            <div style="display:flex;align-items:center;gap:12px">
                <div class="logo" style="width:56px;height:56px;font-size:18px">FL</div>
                <div>
                    <div class="meta" style="font-size:16px;font-weight:600">Moodboard - Visual snapshots</div>
                </div>
            </div>

            <p class="hint" style="margin-top:12px">Sube el archivo RetornosV21.csv y selecciona la fecha que deseas comparar con el último cierre de mes.</p>

            <form id="uploadForm" class="uploader" enctype="multipart/form-data" style="margin-top:12px">
                <div class="top-controls">
                    <input type="file" name="file" id="fileInput" accept=".csv,.txt" />
                    <div class="date-select">
                        <label for="dateSelect">Seleccionar fecha:</label>
                        <select id="dateSelect"></select>
                    </div>
                    <div style="margin-left:auto;display:flex;gap:8px">
                        <button class="btn" type="submit">Procesar</button>
                        <button class="btn" id="pdfBtn" type="button" style="display:none">Generar PDF</button>
                        <button class="btn" id="emailBtn" type="button" style="display:none">Enviar por correo</button>
                        <button type="button" class="btn secondary" id="clearBtn">Limpiar</button>
                    </div>
                </div>
            </form>

            <div id="summary" style="margin-top:8px;font-size:14px;color:#556"></div>
        </div>

        <div id="snapshots-card" class="card table-card" style="max-width:1100px;margin:18px auto;display:none">
            <h3 style="margin-top:0">Valor de Mercado - Mes anterior vs Fecha seleccionada</h3>
            <div id="snapshots-wrap" class="results-table-wrapper"></div>
        </div>

        
    </main>

    <footer class="footer">FLAR - Aplicación interna de reportes. Diseñado para uso corporativo.</footer>

    <script>
    document.getElementById('now').innerText = new Date().toLocaleString();

    function formatNumber(v){
        if (v === null || v === undefined) return '';
        if (typeof v === 'number') return v.toLocaleString(undefined, {maximumFractionDigits:2});
        return v;
    }

    function formatMoney(v){
        if (v === null || v === undefined || v === '') return '';
        if (typeof v === 'number') return v.toLocaleString(undefined, {style: 'currency', currency: 'USD', maximumFractionDigits:2});
        const n = Number(v);
        if (isNaN(n)) return v;
        return n.toLocaleString(undefined, {style: 'currency', currency: 'USD', maximumFractionDigits:2});
    }

    // Helper to populate date selector from rows
    function populateDateSelect(rows){
        const sel = document.getElementById('dateSelect');
        sel.innerHTML = '';
        const dates = Array.from(new Set(rows.map(r => r['End Date'] || r['Date'] || r['LastDate']).filter(Boolean)));
        // sort descending
        dates.sort((a,b)=> new Date(b) - new Date(a));
        for (const d of dates) {
            const opt = document.createElement('option'); opt.value = d; opt.text = d; sel.appendChild(opt);
        }
        return dates;
    }

    async function loadLocal(){
        const resp = await fetch('/retornos/local', { method: 'GET' });
        const text = await resp.text();
        if (!resp.ok) {
            try { const j = JSON.parse(text); alert('Error: ' + (j.detail || JSON.stringify(j))); } catch(e){ alert('Error: ' + text); }
            return null;
        }
        return JSON.parse(text);
    }

    function buildPortfoliosTable(data, selectedDate){
        const rows = data.rows || [];
        const snapshots = data.snapshots || [];
        // map snapshots by account to get PrevMonthEnd / PrevMarketValue
        const snapMap = {};
        for (const s of snapshots) snapMap[s.Account] = s;

        // map rows by account+date for quick lookup
        const rowMap = {};
        for (const r of rows) {
            const key = (r.Account || '') + '|' + (r['End Date'] || r['Date'] || r['LastDate'] || '');
            rowMap[key] = r;
        }

        // determine unique accounts (order by Account)
        const accounts = Array.from(new Set(rows.map(r=>r.Account))).sort();
        let html = '<table class="results"><thead><tr><th>Portafolio</th><th>Prev Month End</th><th>Valor PrevMonthEnd</th><th>' + selectedDate + '</th><th>Valor</th><th>Diff</th><th>% Dif</th></tr></thead><tbody>';
        for (const acct of accounts){
            const snap = snapMap[acct] || {};
            const prevDate = snap.PrevMonthEnd || '';
            const prevVal = snap.PrevMarketValue != null ? snap.PrevMarketValue : '';
            const key = acct + '|' + selectedDate;
            const row = rowMap[key];
            const selVal = row ? row['Total Market Value'] : '';
            const diff = (typeof selVal === 'number' && typeof prevVal === 'number') ? selVal - prevVal : 0;
            const pct = (typeof diff === 'number' && typeof prevVal === 'number' && prevVal !== 0) ? (diff / prevVal * 100) : '';
            const diffClass = (typeof diff === 'number') ? (diff > 0 ? 'positive' : (diff < 0 ? 'negative' : '')) : '';
            const pctClass = (typeof pct === 'number') ? (pct > 0 ? 'positive' : (pct < 0 ? 'negative' : '')) : '';
            html += '<tr>' +
                `<td>${acct}</td>` +
                `<td>${prevDate}</td>` +
                `<td>${formatMoney(prevVal)}</td>` +
                `<td>${selectedDate}</td>` +
                `<td>${formatMoney(selVal)}</td>` +
                `<td class="diff-cell ${diffClass}">${formatMoney(diff)}</td>` +
                `<td class="diff-pct ${pctClass}">${pct !== '' ? pct.toFixed(2) + '%' : ''}</td>` +
                '</tr>';
        }
        html += '</tbody></table>';
        // show snapshots card and render into snapshots-wrap
        const wrap = document.getElementById('snapshots-wrap');
        const card = document.getElementById('snapshots-card');
        if (card) card.style.display = 'block';
        if (wrap) wrap.innerHTML = html; else document.getElementById('file-contents').innerHTML = html;
    }

    function processResponseData(data){
        if (!data) return;
        document.getElementById('summary').innerText = `Filas: ${data.count || 0}`;
        const rows = data.rows || [];
        if (rows.length === 0) { document.getElementById('table-wrap').innerHTML = '<p>No hay datos</p>'; return; }
        const dates = populateDateSelect(rows);
        const defaultDate = dates.length > 0 ? dates[0] : '';
        document.getElementById('dateSelect').value = defaultDate;
        buildPortfoliosTable(data, defaultDate);

        // when changing date selection, rebuild table
        document.getElementById('dateSelect').onchange = (e) => buildPortfoliosTable(data, e.target.value);

        // show pdf and email buttons when data is present
        const pdfBtn = document.getElementById('pdfBtn');
        const emailBtn = document.getElementById('emailBtn');
        if (pdfBtn) { pdfBtn.style.display = 'inline-block'; pdfBtn.onclick = () => generatePDF(data); }
        if (emailBtn) { emailBtn.style.display = 'inline-block'; emailBtn.onclick = () => showEmailModal(data); }
    }

    // form submit
    const form = document.getElementById('uploadForm');
    form.addEventListener('submit', async (e) => {
        e.preventDefault();
        const fileEl = document.getElementById('fileInput');
        const file = fileEl && fileEl.files && fileEl.files[0] ? fileEl.files[0] : null;
        if (!file) { alert('Por favor seleccione un archivo CSV antes de procesar.'); return; }
        const fd = new FormData(); fd.append('file', file);
        const resp = await fetch('/retornos', { method: 'POST', body: fd });
        const text = await resp.text();
        if (!resp.ok) {
            try { const j = JSON.parse(text); alert('Error procesando archivo: ' + (j.detail || JSON.stringify(j))); } catch(er){ alert('Error: ' + text); }
            return;
        }
        const data = JSON.parse(text);
        processResponseData(data);
    });

    // function to call PDF endpoint and download
    async function generatePDF(data){
        try{
            const sel = document.getElementById('dateSelect');
            const selected_date = sel ? sel.value : '';
            const fd = new FormData();
            fd.append('selected_date', selected_date);
            // no file attached: server will use local
            const resp = await fetch('/retornos/pdf', { method: 'POST', body: fd });
            if (!resp.ok) { const txt = await resp.text(); alert('Error generando PDF: ' + txt); return; }
            const blob = await resp.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a'); a.href = url; a.download = `Informe_${selected_date}.pdf`; document.body.appendChild(a); a.click(); a.remove();
        }catch(e){ alert('Error: ' + e); }
    }

    // simple modal to collect SMTP creds and send email
    function showEmailModal(data){
        // create modal markup
        const modal = document.createElement('div');
        modal.style.position = 'fixed'; modal.style.left = 0; modal.style.top = 0; modal.style.right = 0; modal.style.bottom = 0; modal.style.background = 'rgba(0,0,0,0.4)'; modal.style.display = 'flex'; modal.style.alignItems = 'center'; modal.style.justifyContent = 'center';
        const box = document.createElement('div'); box.style.background = '#fff'; box.style.padding = '18px'; box.style.borderRadius = '8px'; box.style.width = '520px'; box.style.maxWidth='95%';
        box.innerHTML = `
            <h3>Enviar informe por correo</h3>
            <div style="display:flex;flex-direction:column;gap:8px;margin-top:8px">
                <label>SMTP Server: <input id="smtp_server" value="smtp.office365.com"/></label>
                <label>SMTP Port: <input id="smtp_port" value="587"/></label>
                <label>Usuario (correo): <input id="smtp_user" value=""/></label>
                <label>Contraseña: <input id="smtp_pass" type="password" value=""/></label>
                <label>Para: <input id="to_email" value="arodriguez@flar.net"/></label>
                <label>Asunto: <input id="email_subject" value="Informe de retornos"/></label>
                <label>Mensaje: <textarea id="email_body" rows="4">Adjunto el informe solicitado.</textarea></label>
                <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:6px">
                    <button id="send_mail_btn" class="btn">Enviar</button>
                    <button id="cancel_mail_btn" class="btn secondary">Cancelar</button>
                </div>
            </div>
        `;
        modal.appendChild(box);
        document.body.appendChild(modal);
        document.getElementById('cancel_mail_btn').onclick = () => modal.remove();
        document.getElementById('send_mail_btn').onclick = async () => {
            const selected_date = document.getElementById('dateSelect').value;
            const smtp_server = document.getElementById('smtp_server').value;
            const smtp_port = document.getElementById('smtp_port').value;
            const smtp_user = document.getElementById('smtp_user').value;
            const smtp_pass = document.getElementById('smtp_pass').value;
            const to_email = document.getElementById('to_email').value;
            const subject = document.getElementById('email_subject').value;
            const body = document.getElementById('email_body').value;
            const fd = new FormData();
            fd.append('selected_date', selected_date);
            fd.append('smtp_server', smtp_server);
            fd.append('smtp_port', smtp_port);
            fd.append('smtp_user', smtp_user);
            fd.append('smtp_pass', smtp_pass);
            fd.append('to_email', to_email);
            fd.append('subject', subject);
            fd.append('body', body);
            try{
                const resp = await fetch('/retornos/email', { method: 'POST', body: fd });
                const j = await resp.json();
                if (!resp.ok) { alert('Error: ' + (j.detail || JSON.stringify(j))); } else { alert('Correo enviado'); modal.remove(); }
            }catch(e){ alert('Error: ' + e); }
        }
    }

    // clear
    document.getElementById('clearBtn').addEventListener('click', () => { const fi = document.getElementById('fileInput'); if (fi) fi.value = null; document.getElementById('dateSelect').innerHTML = ''; document.getElementById('table-wrap').innerHTML = ''; document.getElementById('file-contents').innerHTML = ''; document.getElementById('summary').innerText = ''; });

    </script>
</body>
</html>
