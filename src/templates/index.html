<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>Retornos - Panel FLAR</title>
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <link rel="stylesheet" href="/static/style.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
    /* Small additions for the single-screen responsive layout */
    .top-controls{display:flex;gap:12px;align-items:center;flex-wrap:wrap;margin-bottom:12px}
    .date-select{display:flex;gap:8px;align-items:center}
    .table-card{margin-top:16px}
    @media(max-width:700px){
        .kpi{min-width:100px}
        .uploader .actions{flex-direction:column;align-items:stretch}
    }
    </style>
</head>
<body>
    <header class="header">
        <div class="brand">
            <div class="logo">FL</div>
            <div>
                <h1>FLAR - Retornos</h1>
                <div class="meta">Reporte diario de retornos y valor de mercado</div>
            </div>
        </div>
        <div class="meta">Usuario: Demo &nbsp; | &nbsp; Fecha: <span id="now">--</span></div>
    </header>

    <main class="container">
        <div class="card" style="max-width:900px;margin:20px auto;padding:24px;text-align:left">
            <div style="display:flex;align-items:center;gap:12px">
                <div class="logo" style="width:56px;height:56px;font-size:18px">FL</div>
                <div>
                    <div class="meta" style="font-size:16px;font-weight:600">Moodboard - Visual snapshots</div>
                </div>
            </div>

            <p class="hint" style="margin-top:12px">Sube el archivo RetornosV21.csv y selecciona la fecha que deseas comparar con el último cierre de mes.</p>

            <form id="uploadForm" class="uploader" enctype="multipart/form-data" style="margin-top:12px">
                <div class="top-controls">
                    <input type="file" name="file" id="fileInput" accept=".csv,.txt" />
                    <div class="date-select">
                        <label for="dateSelect">Seleccionar fecha:</label>
                        <select id="dateSelect"></select>
                    </div>
                    <div style="margin-left:auto;display:flex;gap:8px">
                        <button class="btn" type="submit">Procesar</button>
                        <button type="button" class="btn secondary" id="clearBtn">Limpiar</button>
                    </div>
                </div>
            </form>

            <div id="summary" style="margin-top:8px;font-size:14px;color:#556"></div>
        </div>

        <div id="snapshots-card" class="card table-card" style="max-width:1100px;margin:18px auto;display:none">
            <h3 style="margin-top:0">Valor de Mercado - Mes anterior vs Fecha seleccionada</h3>
            <div id="snapshots-wrap" class="results-table-wrapper"></div>
        </div>

        <div id="file-contents" style="margin-top:12px;max-width:1100px;margin-left:auto;margin-right:auto"></div>
    </main>

    <footer class="footer">FLAR - Aplicación interna de reportes. Diseñado para uso corporativo.</footer>

    <script>
    document.getElementById('now').innerText = new Date().toLocaleString();

    function formatNumber(v){
        if (v === null || v === undefined) return '';
        if (typeof v === 'number') return v.toLocaleString(undefined, {maximumFractionDigits:2});
        return v;
    }

    // Helper to populate date selector from rows
    function populateDateSelect(rows){
        const sel = document.getElementById('dateSelect');
        sel.innerHTML = '';
        const dates = Array.from(new Set(rows.map(r => r['End Date'] || r['Date'] || r['LastDate']).filter(Boolean)));
        // sort descending
        dates.sort((a,b)=> new Date(b) - new Date(a));
        for (const d of dates) {
            const opt = document.createElement('option'); opt.value = d; opt.text = d; sel.appendChild(opt);
        }
        return dates;
    }

    async function loadLocal(){
        const resp = await fetch('/retornos/local', { method: 'GET' });
        const text = await resp.text();
        if (!resp.ok) {
            try { const j = JSON.parse(text); alert('Error: ' + (j.detail || JSON.stringify(j))); } catch(e){ alert('Error: ' + text); }
            return null;
        }
        return JSON.parse(text);
    }

    function buildPortfoliosTable(data, selectedDate){
        const rows = data.rows || [];
        const snapshots = data.snapshots || [];
        // map snapshots by account to get PrevMonthEnd / PrevMarketValue
        const snapMap = {};
        for (const s of snapshots) snapMap[s.Account] = s;

        // map rows by account+date for quick lookup
        const rowMap = {};
        for (const r of rows) {
            const key = (r.Account || '') + '|' + (r['End Date'] || r['Date'] || r['LastDate'] || '');
            rowMap[key] = r;
        }

        // determine unique accounts (order by Account)
        const accounts = Array.from(new Set(rows.map(r=>r.Account))).sort();
        let html = '<table class="results"><thead><tr><th>Portafolio</th><th>Prev Month End</th><th>Valor PrevMonthEnd</th><th>' + selectedDate + '</th><th>Valor</th><th>Diff</th><th>% Dif</th></tr></thead><tbody>';
        for (const acct of accounts){
            const snap = snapMap[acct] || {};
            const prevDate = snap.PrevMonthEnd || '';
            const prevVal = snap.PrevMarketValue != null ? snap.PrevMarketValue : '';
            const key = acct + '|' + selectedDate;
            const row = rowMap[key];
            const selVal = row ? row['Total Market Value'] : '';
            const diff = (typeof selVal === 'number' && typeof prevVal === 'number') ? selVal - prevVal : '';
            const pct = (typeof diff === 'number' && typeof prevVal === 'number' && prevVal !== 0) ? (diff / prevVal * 100) : '';
            html += '<tr>' +
                `<td>${acct}</td>` +
                `<td>${prevDate}</td>` +
                `<td>${formatNumber(prevVal)}</td>` +
                `<td>${selectedDate}</td>` +
                `<td>${formatNumber(selVal)}</td>` +
                `<td>${formatNumber(diff)}</td>` +
                `<td>${pct !== '' ? pct.toFixed(2) + '%' : ''}</td>` +
                '</tr>';
        }
        html += '</tbody></table>';
        // show snapshots card and render into snapshots-wrap
        const wrap = document.getElementById('snapshots-wrap');
        const card = document.getElementById('snapshots-card');
        if (card) card.style.display = 'block';
        if (wrap) wrap.innerHTML = html; else document.getElementById('file-contents').innerHTML = html;
    }

    function processResponseData(data){
        if (!data) return;
        document.getElementById('summary').innerText = `Filas: ${data.count || 0}`;
        const rows = data.rows || [];
        if (rows.length === 0) { document.getElementById('table-wrap').innerHTML = '<p>No hay datos</p>'; return; }
        const dates = populateDateSelect(rows);
        const defaultDate = dates.length > 0 ? dates[0] : '';
        document.getElementById('dateSelect').value = defaultDate;
        buildPortfoliosTable(data, defaultDate);

        // preview first rows
        const fileContents = document.getElementById('file-contents');
        let fc = '<h4>Contenido (vista rápida)</h4>';
        const visibleRows = rows.slice(0,200);
        const cols2 = Object.keys(visibleRows[0] || {});
        if (visibleRows.length === 0) fc += '<p>No hay datos</p>';
        else {
            fc += '<div class="results-table-wrapper"><table class="results"><thead><tr>' + cols2.map(c=>`<th>${c}</th>`).join('') + '</tr></thead><tbody>';
            for (const r of visibleRows) fc += '<tr>' + cols2.map(c=>`<td>${r[c] ?? ''}</td>`).join('') + '</tr>';
            fc += '</tbody></table></div>';
        }
        fileContents.innerHTML = fc;

        // when changing date selection, rebuild table
        document.getElementById('dateSelect').onchange = (e) => buildPortfoliosTable(data, e.target.value);
    }

    // initial load (local fallback)
    loadLocal().then(d => { if (d) processResponseData(d); });

    // form submit
    const form = document.getElementById('uploadForm');
    form.addEventListener('submit', async (e) => {
        e.preventDefault();
        const fileEl = document.getElementById('fileInput');
        const file = fileEl && fileEl.files && fileEl.files[0] ? fileEl.files[0] : null;
        if (!file) { const d = await loadLocal(); if (d) processResponseData(d); return; }
        const fd = new FormData(); fd.append('file', file);
        const resp = await fetch('/retornos', { method: 'POST', body: fd });
        const text = await resp.text();
        if (!resp.ok) {
            try { const j = JSON.parse(text); alert('Error procesando archivo: ' + (j.detail || JSON.stringify(j))); } catch(er){ alert('Error: ' + text); }
            return;
        }
        const data = JSON.parse(text);
        processResponseData(data);
    });

    // clear
    document.getElementById('clearBtn').addEventListener('click', () => { const fi = document.getElementById('fileInput'); if (fi) fi.value = null; document.getElementById('dateSelect').innerHTML = ''; document.getElementById('table-wrap').innerHTML = ''; document.getElementById('file-contents').innerHTML = ''; document.getElementById('summary').innerText = ''; });

    </script>
</body>
</html>
